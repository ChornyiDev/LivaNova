# Database Schema for LivaNova

## Overview

The database will be hosted on **Cloud Firestore**. The structure is designed to be scalable, cost-effective (minimizing reads), and supportive of the core "Daily Impulse" logic.

## Collections

### 1. `impulses` (Collection)

Contains all the static content for the impulses. This data is read-only for the client app.

**Document ID**: `impulse_id` (e.g., "1001" or auto-generated, but using a sequence-mapped ID helps).

**Fields**:
| Field Name | Data Type | Description |
| :--- | :--- | :--- |
| `sequence` | Integer | **Critical**. Determines the order of impulses (1, 2, 3...). Used to match with user's progress. |
| `title_short` | String | Short title (max 6 words). |
| `title_full` | String | Full title (max 12 words). |
| `hook_text` | String | Catchy intro text. |
| `motivator_text` | String | Psychological motivation text. |
| `impulse_long_text` | String | The main content. |
| `zones_bridge_text` | String | Transition text to the 5-zone model. |
| `wellbeing_weight` | Integer | Points (1-3) added to user's score upon acceptance. |
| `tags` | Array<String> | For filtering in Library. Initial set: `Morgen`, `Alltag`, `Übergang`, `Hydration`, `Routine`, `Bewegung`, `Aktivierung`. |
| `zones` | Object/Map | Boolean flags for the 5 zones. |
| &nbsp;&nbsp;`sleep` | Boolean | |
| &nbsp;&nbsp;`stress` | Boolean | |
| &nbsp;&nbsp;`heart` | Boolean | |
| &nbsp;&nbsp;`inflammation`| Boolean | |
| &nbsp;&nbsp;`movement` | Boolean | |
| `zone_details` | Object/Map | Specific text for each zone if active. |
| &nbsp;&nbsp;`sleep_text` | String | |
| &nbsp;&nbsp;`stress_text` | String | |
| &nbsp;&nbsp;`heart_text` | String | |
| &nbsp;&nbsp;`inflammation_text`| String | |
| &nbsp;&nbsp;`movement_text` | String | |
| `zone_focus_text` | String | Summary of focus ("Heute stehen Schlaf und Stress..."). |

#### Example Data Structures for Maps:

**`zones` (Map/Object)**:
```json
{
  "sleep": true,
  "stress": true,
  "heart": false,
  "inflammation": false,
  "movement": false
}
```

**`zone_details` (Map/Object)**:
```json
{
  "sleep_text": "Diese Zone steht für Erholung und Rhythmus...",
  "stress_text": "Diese Zone reguliert innere Sicherheit...",
  "heart_text": "",
  "inflammation_text": "",
  "movement_text": ""
}
```

---

### 2. `tags` (Collection)

Simple list of available tags for filtering.

**Document ID**: Auto-generated by Firestore.

**Fields**:
| Field Name | Data Type | Description |
| :--- | :--- | :--- |
| `name` | String | The tag name (e.g., "Morgen"). |

---

### 3. `users` (Collection)

Stores user profile, state, and progress.

**Document ID**: `uid` (from Firebase Auth).

**Fields**:
| Field Name | Data Type | Description |
| :--- | :--- | :--- |
| `email` | String | User email. |
| `display_name` | String | User first name. |
| `photo_url` | String | Profile picture URL. |
| `created_time` | Timestamp | Account creation date. |
| `age` | String/Int | User age group or year. |
| `gender` | String | User gender. |
| **State Tracking** | | |
| `current_impulse_sequence` | Integer | The `sequence` number of the impulse the user is currently on (starts at 1). |
| `last_decision_date` | Date/Timestamp | The date when the last decision (Accept/Not Today) was made. Used to determine if "Done" screen should be shown. |
| **Stats** | | |
| `wellbeing_score` | Integer | Sum of `wellbeing_weight` of all accepted impulses. |
| `saved_count` | Integer | Total number of accepted impulses. |
| `streak_count` | Integer | Days in a row a decision was made. |
| `last_streak_update` | Date/Timestamp | Used to calculate if streak continues or resets. |
| **Settings** | | |
| `is_onboarding_finished` | Boolean | True if user has completed the initial setup. |
| `notifications_enabled` | Boolean | |
| `notification_time_slot` | String | Preferred time slot ("morning", "forenoon", "midday", "afternoon", "evening", "later"). |
| `fcm_tokens` | Array<String> | List of device tokens for push notifications. |

---

### 3. `users/{uid}/library` (Sub-collection)

Stores the impulses that the user has "Accepted".
_Why a sub-collection?_ To allow efficient filtering and searching specific to the user without downloading the entire history effectively.

**Document ID**: `impulse_id` (Same as the global impulse ID).

**Fields**:

- _Copy all fields from the `impulses` document_ (Denormalization is recommended here so the Library view doesn't need to join/read from the main collection for every item, saving reads and ensuring speed).
- **Additional Fields**:
  - `saved_at`: Timestamp (Date when it was accepted).

---

## Scalability Considerations

1.  **Denormalization**: Copying impulse data to the user's library increases storage use slightly but significantly reduces read costs and simplifies "my library" queries.
2.  **Sequence Logic**: Using an Integer `sequence` allows easy reordering of future impulses in the main database without breaking user progress (as long as you don't change the sequence of already consumed ones).
3.  **Pro Version**: The schema supports adding a `isPro` boolean to the user or a `subscription_status` field later.

## Indexing Requirements

- `users/{uid}/library`:
  - Index on `saved_at` (DESC) for default sorting.
  - Index on `title_full` for search.
  - Index on `tags` (Array-contains) for filtering.
  - Index on `zones.sleep`, `zones.stress`, etc., for zone filtering.
